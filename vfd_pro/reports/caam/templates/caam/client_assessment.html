{% load static %}
<!doctype html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Client Advisory Assessment</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Inter (same as Login) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">

  <link rel="stylesheet" href="{% static 'vfd_pro/css/caam.css' %}">

  <style>
    :root {
      --brand-1: #1f3c88;
      --brand-2: #3a6cf4;
      --border: #e1e5eb;
      --muted: #6c757d;
      --bg1: #eef2f7;
      --bg2: #ffffff;
      --shadow: 0 20px 45px rgba(16, 24, 40, .10);
      --radius: 18px;
      --text: #101828;
    }

    html,
    body {
      height: 100%;
    }

    body {
      font-family: 'Inter', sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, #e9f0ff 0%, transparent 60%),
        radial-gradient(900px 600px at 85% 20%, #eaf7ff 0%, transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
    }

    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 28px 18px 52px;
    }

    /* Keep original class names but restyle them to match Login */
    .glass,
    .glass-2 {
      border: 0;
      border-radius: var(--radius);
      background: #fff;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .glass::before,
    .glass-2::before {
      content: "";
      position: absolute;
      inset: -2px;
      background: linear-gradient(135deg, rgba(31, 60, 136, .18), rgba(58, 108, 244, .14));
      filter: blur(18px);
      z-index: 0;
    }

    .glass>*,
    .glass-2>* {
      position: relative;
      z-index: 1;
    }

    .muted {
      color: var(--muted) !important;
    }

    .mono {
      font-variant-numeric: tabular-nums;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .page-title {
      letter-spacing: .2px;
      font-weight: 800;
      font-size: 24px;
      margin: 0;
      color: var(--brand-1);
    }

    .sub {
      margin: 6px 0 0 0;
      color: var(--muted);
      font-size: 14px;
    }

    /* KPI cards */
    .kpi {
      padding: 14px 14px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.75);
    }

    .kpi .label {
      color: var(--muted);
      font-size: 12px;
      font-weight: 600;
    }

    .kpi .val {
      font-size: 22px;
      font-weight: 800;
      letter-spacing: .2px;
      color: #0b1220;
    }

    /* Inputs (match login inputs) */
    .form-control,
    .form-select,
    input[type="text"],
    input[type="number"],
    input[type="email"],
    input[type="password"] {
      border-radius: 12px !important;
      border: 1px solid var(--border) !important;
      min-height: 44px;
      padding: 10px 12px;
      background: #fff;
      transition: box-shadow .15s ease, border-color .15s ease;
    }

    .form-control:focus,
    .form-select:focus,
    input:focus {
      outline: none;
      border-color: rgba(58, 108, 244, .75) !important;
      box-shadow: 0 0 0 .18rem rgba(58, 108, 244, .18) !important;
    }

    .input-group-text {
      border-radius: 12px !important;
      border: 1px solid var(--border) !important;
      background: #f7f9fc;
      color: #344054;
    }

    /* Buttons */
    .btn-login {
      height: 48px;
      border-radius: 12px;
      font-weight: 700;
      border: 0;
      background: linear-gradient(135deg, var(--brand-1), var(--brand-2));
      box-shadow: 0 12px 25px rgba(58, 108, 244, .22);
      transition: transform .08s ease, filter .15s ease;
      color: #fff !important;
    }

    .btn-login:hover {
      filter: brightness(.98);
    }

    .btn-login:active {
      transform: translateY(1px);
    }

    .btn-ghost {
      border-radius: 12px;
      font-weight: 700;
      border: 1px solid rgba(58, 108, 244, .30);
      background: rgba(58, 108, 244, .06);
      color: var(--brand-1);
    }

    .btn-ghost:hover {
      background: rgba(58, 108, 244, .10);
      border-color: rgba(58, 108, 244, .45);
      color: var(--brand-1);
    }

    /* Configuration button -> match theme */
    .config-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 14px;
      font-weight: 700;
      border: 1px solid rgba(58, 108, 244, .35);
      background: rgba(58, 108, 244, .08);
      color: var(--brand-1);
      cursor: pointer;
      user-select: none;
      transition: transform .08s ease, filter .15s ease, background .15s ease, border-color .15s ease;
      box-shadow: 0 8px 18px rgba(58, 108, 244, .10);
    }

    .config-btn:hover {
      background: rgba(58, 108, 244, .12);
      border-color: rgba(58, 108, 244, .50);
    }

    .config-btn:active {
      transform: translateY(1px);
    }

    /* Table */
    .table thead th {
      color: #344054;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: .2px;
      background: #f7f9fc;
      border-bottom: 1px solid var(--border) !important;
    }

    .table td,
    .table th {
      border-top: 1px solid #eef2f7 !important;
      vertical-align: middle;
      color: #101828;
    }

    .table tbody tr:hover td {
      background: rgba(58, 108, 244, .04);
    }

    .progress {
      height: 10px;
      background: #eef2f7;
      border-radius: 999px;
    }

    .progress-bar {
      border-radius: 999px;
    }

    .score-pill {
      background: rgba(58, 108, 244, .08);
      border: 1px solid rgba(58, 108, 244, .18);
      color: var(--brand-1);
      font-weight: 800;
    }

    .badge-soft-success {
      background: rgba(25, 135, 84, 0.10);
      color: #146c43;
      border: 1px solid rgba(25, 135, 84, 0.18);
      font-weight: 700;
    }

    .badge-soft-warning {
      background: rgba(255, 193, 7, 0.14);
      color: #8a6a00;
      border: 1px solid rgba(255, 193, 7, 0.22);
      font-weight: 700;
    }

    .badge-soft-danger {
      background: rgba(220, 53, 69, 0.10);
      color: #b42318;
      border: 1px solid rgba(220, 53, 69, 0.18);
      font-weight: 700;
    }

    .badge-soft {
      background: rgba(16, 24, 40, 0.06);
      color: #475467;
      border: 1px solid rgba(16, 24, 40, 0.10);
      font-weight: 700;
    }

    @media (min-width: 992px) {
      .w-lg-auto {
        width: auto !important;
      }
    }

    /* Compact table */
    .compact-table th,
    .compact-table td {
      padding: 6px 8px !important;
      font-size: 13px;
    }

    .compact-table thead th {
      font-size: 12px;
      font-weight: 700;
      opacity: 1;
    }

    /* Make back buttons consistent with theme */
    #btnBackCriteria,
    #btnBackConfig,
    .btn-back {
      opacity: 1 !important;
      visibility: visible !important;
      color: var(--brand-1) !important;
      border: 1px solid rgba(58, 108, 244, .35) !important;
      background: rgba(58, 108, 244, .06) !important;
      border-radius: 12px !important;
      font-weight: 700;
    }

    #btnBackCriteria:hover,
    #btnBackConfig:hover,
    .btn-back:hover {
      background: rgba(58, 108, 244, .10) !important;
      border-color: rgba(58, 108, 244, .50) !important;
    }

    /* Modal: light + card look */
    .modal-content {
      border: 0;
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
    }

    .modal-content::before {
      content: "";
      position: absolute;
      inset: -2px;
      background: linear-gradient(135deg, rgba(31, 60, 136, .18), rgba(58, 108, 244, .14));
      filter: blur(18px);
      z-index: 0;
    }

    .modal-content>* {
      position: relative;
      z-index: 1;
      background: #fff;
    }

    .modal-header,
    .modal-footer {
      border-color: #eef2f7;
    }

    /* Override your dark modal utility classes to remain readable in light mode */
    .bg-dark {
      background: #fff !important;
    }

    .text-white {
      color: #101828 !important;
    }

    .text-white-50 {
      color: #667085 !important;
    }

    .btn-close-white {
      filter: none !important;
    }

    th.sortable {
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }

    th.sortable .sort-ind {
      display: inline-block;
      width: 14px;
      opacity: .55;
    }

    .grid-filters th {
      background: #fff !important;
      border-top: 1px solid #eef2f7 !important;
    }

    .grid-filters input,
    .grid-filters select {
      min-height: 34px !important;
      height: 34px !important;
      padding: 6px 10px !important;
      border-radius: 10px !important;
    }

    /* Professional blue rounded border */
    .panel-outline {
      border: 1px solid rgba(58, 108, 244, .38) !important;
      border-radius: 18px;
      background: rgba(255, 255, 255, .86);
    }

    .panel-outline .table-responsive {
      border: 1px solid rgba(58, 108, 244, .18);
      border-radius: 16px;
      overflow-x: auto;
      /* allow horizontal scroll */
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
    }

    .panel-outline table {
      min-width: 1200px;
      /* force overflow so scroll appears */
    }

    /* Equal-height KPI tiles */
    .kpi-row>[class*="col-"] {
      display: flex;
    }

    .kpi-row .kpi {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 92px;
      /* adjust if needed */
    }

    /* -----------------------------
   Mobile Cards View
   - Desktop/Tablet: table visible
   - Mobile: cards visible
   ----------------------------- */

    .table-view {
      display: block !important;
    }

    .card-view {
      display: none !important;
    }


    .card-grid {
      display: none;
    }

    /* Mobile breakpoint */
    @media (max-width: 767.98px) {
      .table-view {
        display: none !important;
      }

      .card-view {
        display: block !important;
      }

      /* 2-up cards on mobile (as requested) */
      .card-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
        align-items: stretch;
        /* equal height within row */
      }
    }

    /* Very small phones => 1-up for readability */
    @media (max-width: 420px) {
      .card-grid {
        grid-template-columns: 1fr;
      }
    }

    .caam-card {
      border: 1px solid rgba(58, 108, 244, .18);
      border-radius: 14px;
      background: rgba(255, 255, 255, .92);
      box-shadow: 0 10px 22px rgba(16, 24, 40, .06);
      padding: 10px;
      overflow: hidden;

      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .caam-card__top {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 6px;
    }

    .caam-card__name a {
      font-weight: 800;
      font-size: 13px;
      color: var(--brand-1);
      text-decoration: none;
      line-height: 1.1;
    }

    .caam-card__meta {
      font-size: 12px;
      color: var(--muted);
    }

    .caam-card__grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      flex: 1 1 auto;
    }

    .caam-card__row {
      display: grid;
      grid-template-columns: 130px 1fr;
      gap: 8px;
      align-items: center;
    }

    .caam-card__label {
      font-size: 12px;
      color: #344054;
      font-weight: 700;
    }

    .caam-card .progress {
      height: 8px;
    }

    .caam-card .score-pill {
      font-size: 12px;
    }

    /* Optional: force horizontal scroll for wide table (desktop/tablet) */
    .table-view .table-responsive {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .table-view table {
      min-width: 1200px;
    }

    /* Mobile filters panel (cards view) */
    .mobile-filters {
      border: 1px solid rgba(58, 108, 244, .18);
      border-radius: 16px;
      background: rgba(255, 255, 255, .86);
      padding: 10px;
    }

    .mobile-filters .form-control,
    .mobile-filters .form-select {
      height: 36px;
      min-height: 36px;
      padding: 6px 10px;
      border-radius: 10px !important;
    }


    /* Tablet/Desktop guard: never show cards above mobile breakpoint */
    @media (min-width: 768px) {
      .table-view {
        display: block !important;
      }

      .card-view {
        display: none !important;
      }
    }

    @media (max-width: 576px) {

      .config-modal .table td,
      .config-modal .table th {
        padding: .35rem .4rem;
        font-size: 12px;
        line-height: 1.1;
        vertical-align: middle;
      }
    }

    @media (max-width: 576px) {
      .config-modal .criterion-cell {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 140px;
        /* بسته به عرضت */
      }
    }

    @media (max-width: 576px) {

      .config-modal .enable-toggle .btn,
      .config-modal .enable-toggle button {
        padding: .15rem .45rem;
        font-size: 12px;
        border-radius: 999px;
      }
    }

    @media (max-width: 576px) {
      .config-modal .threshold-cell .input-group {
        flex-wrap: nowrap;
        align-items: center;
      }

      .config-modal .threshold-cell input {
        width: 70px;
        /* یا 60px */
        padding: .15rem .35rem;
        font-size: 12px;
      }

      .config-modal .threshold-cell .input-group-text {
        padding: .15rem .35rem;
        font-size: 12px;
      }
    }
  </style>
</head>

<body data-company-id="{{ company_id|default:'' }}">
  <div class="wrap">

    <!-- Header -->
    <div class="glass panel-outline p-4 mb-3">
      <div class="d-flex flex-column flex-lg-row gap-3 align-items-lg-center justify-content-between">
        <div>
          <h1 class="page-title">Client Advisory Assessment</h1>
          <p class="sub mb-0">
            Company: <span id="companyName" class="fw-semibold">-</span>
            Company ID: <span id="companyIdText" class="mono">-</span>
          </p>

          <!-- Configuration button in header -->
          <button type="button" class="config-btn mt-2" data-bs-toggle="modal"
            data-bs-target="#companyConfigurationModal">
            <span class="config-btn__icon">⚙</span>
            <span class="config-btn__text">Configuration</span>
          </button>
        </div>

        <!-- Controls -->
        <div class="glass panel-outline p-3 w-100 w-lg-auto">
          <div class="row g-2 align-items-end">
            <!-- Search -->
            <div class="col-12 col-lg-8">
              <label class="form-label small mb-1 muted">Search client</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input id="searchInput" class="form-control" list="clientNamesList" />
              </div>
              <datalist id="clientNamesList"></datalist>
            </div>

            <!-- Reset button -->
            <div class="col-12 col-lg-4">
              <button class="btn btn-ghost w-100" id="btnReset">
                <i class="bi bi-arrow-counterclockwise me-1"></i> Reset
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- KPI row -->
      <div class="row g-2 mt-3 kpi-row">
        <div class="col-6 col-lg-3">
          <div class="kpi">
            <div class="label">Target for discussion (Yes)</div>
            <div class="val mono" id="kpiTarget">0</div>
          </div>
        </div>

        <div class="col-6 col-lg-3">
          <div class="kpi">
            <div class="label">R&amp;D opportunity (Yes)</div>
            <div class="val mono" id="kpiRD">0</div>
          </div>
        </div>

        <div class="col-6 col-lg-3">
          <div class="kpi">
            <div class="label">Utilities (Yes)</div>
            <div class="val mono" id="kpiUtilities">0</div>
          </div>
        </div>

        <div class="col-6 col-lg-3">
          <div class="kpi">
            <div class="label">Potential IHT risk (Yes)</div>
            <div class="val mono" id="kpiIHT">0</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="glass panel-outline p-3">
      <div class="table-view">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <!-- <thead>
            <tr>
              <th>Rank</th>
              <th>Client Name</th>
              <th>Reporting Month Used</th>
              <th>Suitability Score</th>
              <th>Opportunity Score</th>
              <th>Readiness Score</th>
              <th>Target For Discussion?</th>
              <th>R&amp;D Opportunity?</th>
              <th>Utilities</th>
              <th>Potential IHT Risk?</th>
            </tr>
          </thead> -->

            <thead>
              <tr>
                <th class="sortable" data-sort="rank">Rank <span class="sort-ind"></span></th>
                <th class="sortable" data-sort="name">Client Name <span class="sort-ind"></span></th>
                <th class="sortable" data-sort="reportDate">Reporting Month Used <span class="sort-ind"></span></th>
                <th class="sortable" data-sort="suitabilityPct">Suitability Score <span class="sort-ind"></span></th>
                <th class="sortable" data-sort="opportunityPct">Opportunity Score <span class="sort-ind"></span></th>
                <th class="sortable" data-sort="readinessPct">Readiness Score <span class="sort-ind"></span></th>
                <th class="sortable" data-sort="tfd">Target For Discussion? <span class="sort-ind"></span></th>
                <th class="sortable" data-sort="rd">R&D Opportunity? <span class="sort-ind"></span></th>
                <th class="sortable" data-sort="utilities">Utilities <span class="sort-ind"></span></th>
                <th class="sortable" data-sort="ihtRisk">Potential IHT Risk? <span class="sort-ind"></span></th>
              </tr>

              <!-- FILTER ROW (جزو Grid) -->
              <tr class="grid-filters">
                <th></th>

                <th>
                  <input id="fName" class="form-control form-control-sm" placeholder="Filter name..." />
                </th>

                <th>
                  <select id="fMonth" class="form-select form-select-sm">
                    <option value="">All months</option>
                  </select>
                </th>

                <th>
                  <input id="fSuitMin" type="number" class="form-control form-control-sm" placeholder="Min %" min="0"
                    max="100" />
                </th>

                <th>
                  <input id="fOppMin" type="number" class="form-control form-control-sm" placeholder="Min %" min="0"
                    max="100" />
                </th>

                <th>
                  <input id="fReadMin" type="number" class="form-control form-control-sm" placeholder="Min %" min="0"
                    max="100" />
                </th>

                <th>
                  <select id="fTFD" class="form-select form-select-sm">
                    <option value="">All</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                  </select>
                </th>

                <th>
                  <select id="fRD" class="form-select form-select-sm">
                    <option value="">All</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                  </select>
                </th>

                <th>
                  <select id="fUtilities" class="form-select form-select-sm">
                    <option value="">All</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                  </select>
                </th>

                <th>
                  <select id="fIHT" class="form-select form-select-sm">
                    <option value="">All</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                  </select>
                </th>
              </tr>
            </thead>

            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div> <!-- /table-view -->

      <!-- Cards (mobile) -->
      <div class="card-view">

        <!-- Mobile filters (cards view). Same filter set as the grid header filters. -->
        <div class="d-md-none mb-2 mobile-filters">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="fw-semibold">Filters</div>
            <button id="mfToggle" class="btn btn-sm btn-outline-primary rounded-pill" type="button">Show</button>
          </div>

          <div id="mfBody" style="display:none;">
            <div class="row g-2">
              <div class="col-12">
                <input id="mfName" class="form-control form-control-sm" placeholder="Filter name..." />
              </div>

              <div class="col-6">
                <select id="mfMonth" class="form-select form-select-sm">
                  <option value="">All months</option>
                </select>
              </div>

              <div class="col-6">
                <select id="mfTFD" class="form-select form-select-sm">
                  <option value="">Target for discussion (All)</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>

              <div class="col-4">
                <input id="mfSuitMin" type="number" class="form-control form-control-sm" placeholder="Suit ≥ %" min="0"
                  max="100" />
              </div>
              <div class="col-4">
                <input id="mfOppMin" type="number" class="form-control form-control-sm" placeholder="Opp ≥ %" min="0"
                  max="100" />
              </div>
              <div class="col-4">
                <input id="mfReadMin" type="number" class="form-control form-control-sm" placeholder="Ready ≥ %" min="0"
                  max="100" />
              </div>

              <div class="col-4">
                <select id="mfRD" class="form-select form-select-sm">
                  <option value="">R&amp;D (All)</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>

              <div class="col-4">
                <select id="mfUtilities" class="form-select form-select-sm">
                  <option value="">Utilities (All)</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>

              <div class="col-4">
                <select id="mfIHT" class="form-select form-select-sm">
                  <option value="">IHT risk (All)</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>

              <div class="col-12 d-flex gap-2">
                <button id="mfClear" class="btn btn-sm btn-outline-secondary w-100" type="button">Clear</button>
                <button id="mfApply" class="btn btn-sm btn-primary w-100" type="button">Apply</button>
              </div>
            </div>
          </div>
        </div>

        <div id="cardGrid" class="card-grid"></div>
      </div>

    </div>

  </div>

  <script>
    // --------------------------------------------
    // CAAM Report Grid (loads from SP via Django API)
    // --------------------------------------------

    const elSearch = document.getElementById("searchInput");
    const elBody = document.getElementById("tbody");

    // Card container (mobile)
    const elCardGrid = document.getElementById("cardGrid");

    const elCompanyName = document.getElementById("companyName");
    const elCompanyIdText = document.getElementById("companyIdText");

    const kpiTarget = document.getElementById("kpiTarget");
    const kpiRD = document.getElementById("kpiRD");
    const kpiUtilities = document.getElementById("kpiUtilities");
    const kpiIHT = document.getElementById("kpiIHT");

    const elClientNamesList = document.getElementById("clientNamesList");

    function populateClientDatalist(rowsMapped) {
      const names = [...new Set(rowsMapped.map(r => (r.name || "").trim()).filter(Boolean))].sort();
      elClientNamesList.innerHTML = names.map(n => `<option value="${n}"></option>`).join("");
    }


    function getCompanyId() {
      const qs = new URLSearchParams(window.location.search);
      const fromQs = qs.get("company_id");
      if (fromQs && !isNaN(Number(fromQs))) return Number(fromQs);

      const fromData = document.body?.dataset?.companyId;
      if (fromData && !isNaN(Number(fromData))) return Number(fromData);

      if (typeof window.COMPANY_ID !== "undefined" && !isNaN(Number(window.COMPANY_ID))) {
        return Number(window.COMPANY_ID);
      }

      return null;
    }

    function reportUrl(companyId) {
      return `/companies/${companyId}/ajax/report/`;
    }

    function clientSummaryUrl(clientId, companyId) {
      const base = `/clients/${clientId}/summary/?company_id=${encodeURIComponent(companyId)}`;
      return `${base}&from=assessment`;
    }

    async function loadReport(companyId) {
      const res = await fetch(reportUrl(companyId), { method: "GET" });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Report API error");
      return data.rows || [];
    }

    function yesNoBadge(v) {
      const s = String(v ?? "").trim().toLowerCase();
      const isYes = (s === "yes" || s === "true" || s === "1");
      return isYes
        ? `<span class="badge badge-soft-success rounded-pill px-3 py-2"><i class="bi bi-check2 me-1"></i>Yes</span>`
        : `<span class="badge badge-soft rounded-pill px-3 py-2"><i class="bi bi-dash-lg me-1"></i>No</span>`;
    }

    function scoreCell(label, pctVal) {
      const value = Math.max(0, Math.min(100, Math.round(Number(pctVal ?? 0))));
      return `
        <div class="d-flex align-items-center gap-2">
          <span class="badge score-pill rounded-pill mono">${value}%</span>
          <div class="flex-grow-1">
            <div class="progress" role="progressbar" aria-label="${label}"
                aria-valuenow="${value}" aria-valuemin="0" aria-valuemax="100">
              <div class="progress-bar" style="width:${value}%"></div>
            </div>
          </div>
        </div>
      `;
    }
    function renderCards(sortedRows) {
      if (!elCardGrid) return;

      if (!sortedRows || !sortedRows.length) {
        elCardGrid.innerHTML = `
          <div class="caam-card">
            <div class="fw-semibold mb-1">No results found</div>
            <div class="muted">Try clearing filters.</div>
          </div>
        `;
        return;
      }

      elCardGrid.innerHTML = sortedRows.map((r, idx) => `
        <div class="caam-card">
          <div class="caam-card__top">
            <span class="badge bg-light text-dark border rounded-pill px-3 py-2 mono">#${idx + 1}</span>
            <span class="mono caam-card__meta">${r.reportDate ?? "-"}</span>
          </div>

          <div class="caam-card__name mb-1">
            <a href="${clientSummaryUrl(r.clientId, r.companyId)}">${r.name}</a>
          </div>

          <div class="caam-card__grid">
            <div class="caam-card__row">
              <div class="caam-card__label">Suitability</div>
              <div>${scoreCell("Suitability", r.suitabilityPct)}</div>
            </div>

            <div class="caam-card__row">
              <div class="caam-card__label">Opportunity</div>
              <div>${scoreCell("Opportunity", r.opportunityPct)}</div>
            </div>

            <div class="caam-card__row">
              <div class="caam-card__label">Readiness</div>
              <div>${scoreCell("Readiness", r.readinessPct)}</div>
            </div>

            <div class="caam-card__row">
              <div class="caam-card__label">Target for discussion</div>
              <div>${yesNoBadge(r.tfd)}</div>
            </div>

            <div class="caam-card__row">
              <div class="caam-card__label">R&amp;D opportunity</div>
              <div>${yesNoBadge(r.rd)}</div>
            </div>

            <div class="caam-card__row">
              <div class="caam-card__label">Utilities</div>
              <div>${yesNoBadge(r.utilities)}</div>
            </div>

            <div class="caam-card__row">
              <div class="caam-card__label">Potential IHT risk</div>
              <div>${yesNoBadge(r.ihtRisk)}</div>
            </div>
          </div>
        </div>
      `).join("");
    }



    function mapRow(r) {
      return {
        clientId: r.client_id,
        companyId: r.company_id,
        name: r.client_name ?? r.client ?? r.clientName ?? "-",
        reportDate: r.reporting_month_label ?? r.reporting_date ?? r.report_date ?? "-",
        suitabilityPct: r.suitability_score ?? r.suitability ?? 0,
        opportunityPct: r.opportunity_score ?? r.opportunity ?? 0,
        readinessPct: r.readiness_score ?? r.readiness ?? 0,
        tfd: r.target_for_discussion ?? r.target_for_discussion_flag ?? r.tfd,
        rd: r.rd_opportunity ?? r.rd_flag ?? r.rd,
        utilities: r.utilities_flag ?? "No",
        // ihtRisk: r.iht_risk ?? r.iht ?? r.risk ?? "No",
        ihtRisk: r.potential_iht_risk,
        companyName: r.company_name ?? null,
      };
    }

    // function renderTable(rowsMapped) {
    //   const q = (elSearch.value || "").trim().toLowerCase();
    //   const filtered = rowsMapped.filter(r => !q || String(r.name).toLowerCase().includes(q));

    //   // KPIs
    //   kpiTarget.textContent = filtered.filter(r => String(r.tfd).toLowerCase() === "yes").length;
    //   kpiRD.textContent = filtered.filter(r => String(r.rd).toLowerCase() === "yes").length;
    //   kpiUtilities.textContent = filtered.filter(r => String(r.utilities).toLowerCase() === "yes").length;
    //   kpiIHT.textContent = filtered.filter(r => String(r.ihtRisk).toLowerCase() === "yes").length;

    //   if (!filtered.length) {
    //     elBody.innerHTML = `
    //       <tr>
    //         <td colspan="10" class="text-center py-5">
    //           <div class="fw-semibold mb-2">No results found</div>
    //           <div class="muted">Try clearing the search box.</div>
    //         </td>
    //       </tr>
    //     `;
    //     return;
    //   }

    //   elBody.innerHTML = filtered.map((r, idx) => `
    //     <tr>
    //       <td class="mono">
    //         <span class="badge bg-light text-dark border rounded-pill px-3 py-2 mono">#${idx + 1}</span>
    //       </td>

    //       <td>
    //         <a class="fw-semibold text-decoration-none" style="color: var(--brand-1);"
    //           href="${clientSummaryUrl(r.clientId, r.companyId)}">
    //           ${r.name}
    //         </a>
    //       </td>

    //       <td class="mono">${r.reportDate ?? "-"}</td>
    //       <td>${scoreCell("Suitability", r.suitabilityPct)}</td>
    //       <td>${scoreCell("Opportunity", r.opportunityPct)}</td>
    //       <td>${scoreCell("Readiness", r.readinessPct)}</td>

    //       <td>${yesNoBadge(r.tfd)}</td>
    //       <td>${yesNoBadge(r.rd)}</td>
    //       <td>${yesNoBadge(r.utilities)}</td>
    //       <td>${yesNoBadge(r.ihtRisk)}</td>
    //     </tr>
    //   `).join("");
    // }

    function normalizeYesNo(v) {
      const s = String(v ?? "").trim().toLowerCase();
      return (s === "yes" || s === "true" || s === "1") ? "Yes" : "No";
    }

    function monthKey(reportDateStr) {
      // انتظار: "Oct 2025" یا شبیه این
      // اگر فرمت فرق داشت، همینجا تنظیم می‌کنیم
      const s = String(reportDateStr ?? "").trim();
      if (!s) return 0;

      const parts = s.split(/\s+/); // ["Oct","2025"]
      if (parts.length < 2) return 0;

      const m = parts[0].slice(0, 3).toLowerCase();
      const y = parseInt(parts[1], 10);

      const map = {
        jan: 1, feb: 2, mar: 3, apr: 4, may: 5, jun: 6,
        jul: 7, aug: 8, sep: 9, oct: 10, nov: 11, dec: 12
      };

      const mm = map[m] || 0;
      if (!y || !mm) return 0;
      return y * 100 + mm; // مثال: 202510
    }

    function applyFilters(rows) {
      const f = gridState.filters;

      const nameQ = (f.name || "").trim().toLowerCase();
      const month = (f.month || "").trim();
      const suitMin = f.suitMin === "" ? null : Number(f.suitMin);
      const oppMin = f.oppMin === "" ? null : Number(f.oppMin);
      const readMin = f.readMin === "" ? null : Number(f.readMin);

      return rows.filter(r => {
        if (nameQ && !String(r.name || "").toLowerCase().includes(nameQ)) return false;
        if (month && String(r.reportDate || "") !== month) return false;

        if (suitMin !== null && Number(r.suitabilityPct || 0) < suitMin) return false;
        if (oppMin !== null && Number(r.opportunityPct || 0) < oppMin) return false;
        if (readMin !== null && Number(r.readinessPct || 0) < readMin) return false;

        if (f.tfd && normalizeYesNo(r.tfd) !== f.tfd) return false;
        if (f.rd && normalizeYesNo(r.rd) !== f.rd) return false;
        if (f.utilities && normalizeYesNo(r.utilities) !== f.utilities) return false;
        if (f.iht && normalizeYesNo(r.ihtRisk) !== f.iht) return false;

        return true;
      });
    }

    function sortRows(rows) {
      const { sortKey, sortDir } = gridState;
      const dir = sortDir === "asc" ? 1 : -1;

      const getVal = (r) => {
        switch (sortKey) {
          case "rank": return 0; // بعداً بر اساس index رندر می‌کنیم
          case "name": return String(r.name || "").toLowerCase();
          case "reportDate": return monthKey(r.reportDate);
          case "suitabilityPct": return Number(r.suitabilityPct || 0);
          case "opportunityPct": return Number(r.opportunityPct || 0);
          case "readinessPct": return Number(r.readinessPct || 0);
          case "tfd": return normalizeYesNo(r.tfd);
          case "rd": return normalizeYesNo(r.rd);
          case "utilities": return normalizeYesNo(r.utilities);
          case "ihtRisk": return normalizeYesNo(r.ihtRisk);
          default: return "";
        }
      };

      // Rank را بعد از sort به صورت index می‌گذاریم، پس اینجا مهم نیست
      const sorted = [...rows].sort((a, b) => {
        const va = getVal(a);
        const vb = getVal(b);

        if (typeof va === "number" && typeof vb === "number") return (va - vb) * dir;
        return String(va).localeCompare(String(vb)) * dir;
      });

      return sorted;
    }

    function renderTable(rowsMapped) {
      // 1) filter
      const filtered = applyFilters(rowsMapped);

      // 2) sort
      const sorted = sortRows(filtered);


      // Render cards (mobile) from the same filtered/sorted dataset
      renderCards(sorted);

      // KPIs بر اساس filtered (یا اگر دوست داری بر اساس کل داده، بگو)
      kpiTarget.textContent = filtered.filter(r => normalizeYesNo(r.tfd) === "Yes").length;
      kpiRD.textContent = filtered.filter(r => normalizeYesNo(r.rd) === "Yes").length;
      kpiUtilities.textContent = filtered.filter(r => normalizeYesNo(r.utilities) === "Yes").length;
      kpiIHT.textContent = filtered.filter(r => normalizeYesNo(r.ihtRisk) === "Yes").length;

      if (!sorted.length) {
        elBody.innerHTML = `
      <tr>
        <td colspan="10" class="text-center py-5">
          <div class="fw-semibold mb-2">No results found</div>
          <div class="muted">Try clearing filters.</div>
        </td>
      </tr>
    `;
        return;
      }

      elBody.innerHTML = sorted.map((r, idx) => `
    <tr>
      <td class="mono">
        <span class="badge bg-light text-dark border rounded-pill px-3 py-2 mono">#${idx + 1}</span>
      </td>

      <td>
        <a class="fw-semibold text-decoration-none" style="color: var(--brand-1);"
          href="${clientSummaryUrl(r.clientId, r.companyId)}">
          ${r.name}
        </a>
      </td>

      <td class="mono">${r.reportDate ?? "-"}</td>
      <td>${scoreCell("Suitability", r.suitabilityPct)}</td>
      <td>${scoreCell("Opportunity", r.opportunityPct)}</td>
      <td>${scoreCell("Readiness", r.readinessPct)}</td>

      <td>${yesNoBadge(r.tfd)}</td>
      <td>${yesNoBadge(r.rd)}</td>
      <td>${yesNoBadge(r.utilities)}</td>
      <td>${yesNoBadge(r.ihtRisk)}</td>
    </tr>
  `).join("");
    }

    const gridState = {
      sortKey: "rank",
      sortDir: "asc", // asc | desc
      filters: {
        name: "",
        month: "",
        suitMin: "",
        oppMin: "",
        readMin: "",
        tfd: "",
        rd: "",
        utilities: "",
        iht: ""
      }
    };

    function bindGridFilters() {
      const byId = (id) => document.getElementById(id);

      const fName = byId("fName");
      const fMonth = byId("fMonth");
      const fSuitMin = byId("fSuitMin");
      const fOppMin = byId("fOppMin");
      const fReadMin = byId("fReadMin");
      const fTFD = byId("fTFD");
      const fRD = byId("fRD");
      const fUtilities = byId("fUtilities");
      const fIHT = byId("fIHT");

      const apply = () => renderTable(cachedRows);

      if (fName) fName.addEventListener("input", () => { gridState.filters.name = fName.value; apply(); });
      if (fMonth) fMonth.addEventListener("change", () => { gridState.filters.month = fMonth.value; apply(); });

      if (fSuitMin) fSuitMin.addEventListener("input", () => { gridState.filters.suitMin = fSuitMin.value; apply(); });
      if (fOppMin) fOppMin.addEventListener("input", () => { gridState.filters.oppMin = fOppMin.value; apply(); });
      if (fReadMin) fReadMin.addEventListener("input", () => { gridState.filters.readMin = fReadMin.value; apply(); });

      if (fTFD) fTFD.addEventListener("change", () => { gridState.filters.tfd = fTFD.value; apply(); });
      if (fRD) fRD.addEventListener("change", () => { gridState.filters.rd = fRD.value; apply(); });
      if (fUtilities) fUtilities.addEventListener("change", () => { gridState.filters.utilities = fUtilities.value; apply(); });
      if (fIHT) fIHT.addEventListener("change", () => { gridState.filters.iht = fIHT.value; apply(); });
    }

    // function bindSorting() {
    //   document.querySelectorAll("th.sortable").forEach(th => {
    //     th.addEventListener("click", () => {
    //       const key = th.dataset.sort;
    //       if (!key) return;

    //       if (gridState.sortKey === key) {
    //         gridState.sortDir = (gridState.sortDir === "asc") ? "desc" : "asc";
    //       } else {
    //         gridState.sortKey = key;
    //         gridState.sortDir = "asc";
    //       }
    //       renderTable(cachedRows);
    //       updateSortIndicators();
    //     });
    //   });
    // }

    // function updateSortIndicators() {
    //   document.querySelectorAll("th.sortable .sort-ind").forEach(el => el.textContent = "");
    //   const active = document.querySelector(`th.sortable[data-sort="${gridState.sortKey}"] .sort-ind`);
    //   if (active) active.textContent = (gridState.sortDir === "asc") ? "▲" : "▼";
    // }



    let cachedRows = [];

    async function refresh() {
      const companyId = getCompanyId();

      if (!companyId) {
        elBody.innerHTML = `
          <tr>
            <td colspan="10" class="text-danger">
              company_id not provided. Use <span class="mono">?company_id=123</span>
              (or set <span class="mono">data-company-id</span> on body, or <span class="mono">window.COMPANY_ID</span>).
            </td>
          </tr>
        `;
        return;
      }

      elBody.innerHTML = `<tr><td colspan="10">Loading...</td></tr>`;

      try {
        const rows = await loadReport(companyId);
        cachedRows = rows.map(mapRow);
        initMonthFilterOptions(cachedRows);
        // Sync month options into mobile filters (cards view)
        if (typeof mfSyncMonthOptions === "function") mfSyncMonthOptions();
        populateClientDatalist(cachedRows);
        renderTable(cachedRows);
        bindGridFilters();
        // bindSorting();
        // updateSortIndicators();


        elCompanyName.textContent = cachedRows.length ? (cachedRows[0].companyName || "-") : "-";
        elCompanyIdText.textContent = String(companyId);
      } catch (e) {
        elBody.innerHTML = `<tr><td colspan="10" class="text-danger">${e.message}</td></tr>`;
      }
    }

    // Events
    // document.getElementById("btnReset").addEventListener("click", () => {
    //   elSearch.value = "";
    //   renderTable(cachedRows);
    // });

    document.getElementById("btnReset").addEventListener("click", () => {
      // clear top search
      elSearch.value = "";

      // clear grid filters state
      gridState.filters = {
        name: "", month: "", suitMin: "", oppMin: "", readMin: "",
        tfd: "", rd: "", utilities: "", iht: ""
      };

      // clear UI inputs (if present)
      ["fName", "fMonth", "fSuitMin", "fOppMin", "fReadMin", "fTFD", "fRD", "fUtilities", "fIHT", "searchInput", "mfName", "mfMonth", "mfSuitMin", "mfOppMin", "mfReadMin", "mfTFD", "mfRD", "mfUtilities", "mfIHT"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = "";
      });
      const topSearch = document.getElementById("searchInput");
      if (topSearch) topSearch.value = "";


      renderTable(cachedRows);
    });

    elSearch.addEventListener("input", () => {
      // Keep top search aligned with grid filters
      gridState.filters.name = elSearch.value || "";
      const fName = document.getElementById("fName");
      if (fName && fName.value !== elSearch.value) fName.value = elSearch.value;
      const mfName = document.getElementById("mfName");
      if (mfName && mfName.value !== elSearch.value) mfName.value = elSearch.value;
      renderTable(cachedRows);
    });

    // Mobile filters (cards view) - keep the same filtering logic (gridState + renderTable).
    const mf = {
      toggle: document.getElementById("mfToggle"),
      body: document.getElementById("mfBody"),
      apply: document.getElementById("mfApply"),
      clear: document.getElementById("mfClear"),
      name: document.getElementById("mfName"),
      month: document.getElementById("mfMonth"),
      suitMin: document.getElementById("mfSuitMin"),
      oppMin: document.getElementById("mfOppMin"),
      readMin: document.getElementById("mfReadMin"),
      tfd: document.getElementById("mfTFD"),
      rd: document.getElementById("mfRD"),
      utilities: document.getElementById("mfUtilities"),
      iht: document.getElementById("mfIHT"),
    };

    function mfSyncMonthOptions() {
      const src = document.getElementById("fMonth");
      if (src && mf.month) mf.month.innerHTML = src.innerHTML;
    }

    function mfSyncFromState() {
      const s = gridState.filters;
      const set = (el, v) => { if (el) el.value = String(v ?? ""); };

      set(mf.name, s.name);
      set(mf.month, s.month);
      set(mf.suitMin, s.suitMin);
      set(mf.oppMin, s.oppMin);
      set(mf.readMin, s.readMin);
      set(mf.tfd, s.tfd);
      set(mf.rd, s.rd);
      set(mf.utilities, s.utilities);
      set(mf.iht, s.iht);
    }

    function mfApplyToState() {
      gridState.filters.name = mf.name?.value || "";
      gridState.filters.month = mf.month?.value || "";
      gridState.filters.suitMin = mf.suitMin?.value || "";
      gridState.filters.oppMin = mf.oppMin?.value || "";
      gridState.filters.readMin = mf.readMin?.value || "";
      gridState.filters.tfd = mf.tfd?.value || "";
      gridState.filters.rd = mf.rd?.value || "";
      gridState.filters.utilities = mf.utilities?.value || "";
      gridState.filters.iht = mf.iht?.value || "";

      // Keep desktop header filter inputs in sync (if they exist)
      const fName = document.getElementById("fName");
      if (fName && fName.value !== gridState.filters.name) fName.value = gridState.filters.name;

      const elSearch = document.getElementById("searchInput");
      if (elSearch && elSearch.value !== gridState.filters.name) elSearch.value = gridState.filters.name;
    }

    if (mf.toggle && mf.body) {
      mf.toggle.addEventListener("click", () => {
        const isOpen = mf.body.style.display !== "none";
        mf.body.style.display = isOpen ? "none" : "block";
        mf.toggle.textContent = isOpen ? "Show" : "Hide";
      });
    }

    if (mf.apply) {
      mf.apply.addEventListener("click", () => {
        mfApplyToState();
        renderTable(cachedRows);
      });
    }

    if (mf.clear) {
      mf.clear.addEventListener("click", () => {
        if (mf.name) mf.name.value = "";
        if (mf.month) mf.month.value = "";
        if (mf.suitMin) mf.suitMin.value = "";
        if (mf.oppMin) mf.oppMin.value = "";
        if (mf.readMin) mf.readMin.value = "";
        if (mf.tfd) mf.tfd.value = "";
        if (mf.rd) mf.rd.value = "";
        if (mf.utilities) mf.utilities.value = "";
        if (mf.iht) mf.iht.value = "";
        mfApplyToState();
        renderTable(cachedRows);
      });
    }

    // Instant filtering on mobile (typing/selecting should filter immediately)
    ["input", "change"].forEach((evt) => {
      [mf.name, mf.month, mf.suitMin, mf.oppMin, mf.readMin, mf.tfd, mf.rd, mf.utilities, mf.iht]
        .filter(Boolean)
        .forEach((el) => el.addEventListener(evt, () => {
          mfApplyToState();
          renderTable(cachedRows);
        }));
    });

    // Init month options + initial sync once data is loaded (we call this after initMonthFilterOptions runs too)
    mfSyncMonthOptions();
    mfSyncFromState();



    refresh();
  </script>

  <!-- ========== Settings Modal (MINIMAL) ========== -->
  <div class="modal fade caam-modal config-modal" id="companyConfigurationModal" tabindex="-1"
    aria-labelledby="opportunityCriteriaLabel" aria-hidden="true">

    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">

        <form method="post" action="">
          {% csrf_token %}

          <div class="modal-header">
            <h5 class="modal-title" id="opportunityCriteriaLabel">Setting</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body caam-modal__body">

            <!-- OUTER TABS -->
            <ul class="nav nav-tabs caam-tabs mb-2" role="tablist">

              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="outer-suitability-tab" data-bs-toggle="tab"
                  data-bs-target="#outer-suitability" type="button" role="tab" aria-controls="outer-suitability"
                  aria-selected="true">
                  Suitability
                </button>
              </li>

              <li class="nav-item" role="presentation">
                <button class="nav-link" id="outer-opportunity-tab" data-bs-toggle="tab"
                  data-bs-target="#outer-opportunity" type="button" role="tab" aria-controls="outer-opportunity"
                  aria-selected="false">
                  Opportunity
                </button>
              </li>

              <li class="nav-item" role="presentation">
                <button class="nav-link" id="outer-iht-tab" data-bs-toggle="tab" data-bs-target="#outer-iht"
                  type="button" role="tab" aria-controls="outer-iht" aria-selected="false">
                  IHT
                </button>
              </li>

              <li class="nav-item" role="presentation">
                <button class="nav-link" id="outer-readiness-tab" data-bs-toggle="tab" data-bs-target="#outer-readiness"
                  type="button" role="tab" aria-controls="outer-readiness" aria-selected="false">
                  Readiness
                </button>
              </li>

            </ul>

            <div class="tab-content">

              <!-- ===================== SUITABILITY (Enable only) ===================== -->
              <div class="tab-pane fade show active" id="outer-suitability" role="tabpanel"
                aria-labelledby="outer-suitability-tab">

                <!-- Target (Suitability) -->
                <div class="row g-2 mb-2">
                  <div class="col-12 col-md-4">
                    <label class="form-label small text-muted">Suitability target %</label>
                    <input type="number" min="0" max="100" step="1" name="suitability_target_percent"
                      id="target_suitability" class="form-control form-control-sm"
                      value="{{ suitability_settings.target_percent|default_if_none:'' }}">
                  </div>
                </div>

                <div class="table-responsive">
                  <table class="table table-sm align-middle caam-table caam-table--yn">
                    <thead>
                      <tr>
                        <th>Enable</th>
                        <th>Field</th>
                      </tr>
                    </thead>

                    <tbody>
                      {% for row in suitability_settings.rows %}
                      <tr>
                        <td>
                          <select name="{{ row.enabled_name }}" id="id_{{ row.enabled_name }}"
                            class="form-select form-select-sm caam-select-yn">
                            <option value="Yes" {% if row.enabled_is_yes %}selected{% endif %}>Yes</option>
                            <option value="No" {% if row.enabled_is_no %}selected{% endif %}>No</option>
                          </select>
                        </td>

                        <td>{{ row.label }}</td>
                      </tr>
                      {% empty %}
                      <tr>
                        <td colspan="2" class="text-muted text-center py-2">
                          No suitability rows found.
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>

              </div>

              <!-- ===================== OPPORTUNITY ===================== -->
              <div class="tab-pane fade" id="outer-opportunity" role="tabpanel" aria-labelledby="outer-opportunity-tab">

                <div class="row g-2 mb-2">
                  <div class="col-12 col-md-4">
                    <label class="form-label small text-muted">Opportunity target %</label>
                    <input type="number" min="0" max="100" step="1" name="opp_target_percent" id="target_opportunity"
                      class="form-control form-control-sm"
                      value="{{ perf_settings.target_percent|default_if_none:'' }}">

                  </div>
                </div>

                <!-- Shared controls -->
                <div class="row g-2 mb-2 caam-controls">

                  <div class="col-12 col-md-4">
                    <label class="form-label small text-muted">Time period</label>
                    <select name="{{ perf_settings.period.name }}" id="{{ perf_settings.period.id }}"
                      class="form-select form-select-sm">
                      <option value="12" {% if perf_settings.period.is_12 %}selected{% endif %}>Last 12 months</option>
                      <option value="6" {% if perf_settings.period.is_6 %}selected{% endif %}>Last 6 months</option>
                      <option value="3" {% if perf_settings.period.is_3 %}selected{% endif %}>Last 3 months</option>
                    </select>
                  </div>

                  <div class="col-12 col-md-4">
                    <label class="form-label small text-muted">Multiple</label>
                    <input type="number" class="form-control form-control-sm" name="{{ perf_settings.multiple.name }}"
                      id="{{ perf_settings.multiple.id }}" step="1" min="0" max="99"
                      value="{{ perf_settings.multiple.value|default_if_none:'' }}">
                  </div>

                </div>

                <!-- INNER TABS -->
                <ul class="nav nav-tabs caam-tabs caam-tabs--inner mb-2" role="tablist">

                  <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="inner-perf-tab" data-bs-toggle="tab"
                      data-bs-target="#inner-perf" type="button" role="tab" aria-controls="inner-perf"
                      aria-selected="true">
                      Performance
                    </button>
                  </li>

                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="inner-wc-tab" data-bs-toggle="tab" data-bs-target="#inner-wc"
                      type="button" role="tab" aria-controls="inner-wc" aria-selected="false">
                      Working Capital
                    </button>
                  </li>

                </ul>

                <div class="tab-content">

                  <!-- ========= Performance ========= -->
                  <div class="tab-pane fade show active" id="inner-perf" role="tabpanel"
                    aria-labelledby="inner-perf-tab">

                    <div class="table-responsive">
                      <table class="table table-sm align-middle caam-table caam-table--rule">
                        <thead>
                          <tr>
                            <th>Enable</th>
                            <th>Criterion</th>
                            <th>Dir</th>
                            <th>Threshold</th>
                          </tr>
                        </thead>

                        <tbody>
                          {% for r in perf_settings.group1 %}
                          <tr>
                            <td>
                              <select id="{{ r.enable.id }}" name="{{ r.enable.name }}"
                                class="form-select form-select-sm caam-select-yn">
                                <option value="Yes" {% if r.enable.is_yes %}selected{% endif %}>Yes</option>
                                <option value="No" {% if r.enable.is_no %}selected{% endif %}>No</option>
                              </select>
                            </td>

                            <td class="criterion-cell">{{ r.label }}</td>

                            <td>
                              <select id="{{ r.sign.id }}" name="{{ r.sign.name }}" class="form-select form-select-sm">
                                <option value="+/-" {% if r.sign.is_pm %}selected{% endif %}>+/-</option>
                                <option value="+" {% if r.sign.is_plus %}selected{% endif %}>+</option>
                                <option value="-" {% if r.sign.is_minus %}selected{% endif %}>-</option>
                              </select>
                            </td>

                            <td class="threshold-cell">
                              <div class="input-group input-group-sm">
                                <input id="{{ r.threshold.id }}" name="{{ r.threshold.name }}" type="number" step="0.01"
                                  class="form-control form-control-sm"
                                  value="{{ r.threshold.value|default_if_none:'' }}">
                                <span class="input-group-text">%</span>
                              </div>
                            </td>
                          </tr>
                          {% endfor %}

                          {% for r in perf_settings.group2 %}
                          <tr>
                            <td>
                              <select id="{{ r.enable.id }}" name="{{ r.enable.name }}"
                                class="form-select form-select-sm caam-select-yn">
                                <option value="Yes" {% if r.enable.is_yes %}selected{% endif %}>Yes</option>
                                <option value="No" {% if r.enable.is_no %}selected{% endif %}>No</option>
                              </select>
                            </td>

                            <td class="criterion-cell">{{ r.label }}</td>

                            <td>
                              <select id="{{ r.sign.id }}" name="{{ r.sign.name }}" class="form-select form-select-sm">
                                <option value="+/-" {% if r.sign.is_pm %}selected{% endif %}>+/-</option>
                                <option value="+" {% if r.sign.is_plus %}selected{% endif %}>+</option>
                                <option value="-" {% if r.sign.is_minus %}selected{% endif %}>-</option>
                              </select>
                            </td>

                            <td class="threshold-cell">
                              <div class="input-group input-group-sm">
                                <input id="{{ r.threshold.id }}" name="{{ r.threshold.name }}" type="number" step="0.01"
                                  class="form-control form-control-sm"
                                  value="{{ r.threshold.value|default_if_none:'' }}">
                                <span class="input-group-text">%</span>
                              </div>
                            </td>
                          </tr>
                          {% endfor %}

                          {% for r in perf_settings.group3 %}
                          <tr>
                            <td>
                              <select id="{{ r.enable.id }}" name="{{ r.enable.name }}"
                                class="form-select form-select-sm caam-select-yn">
                                <option value="Yes" {% if r.enable.is_yes %}selected{% endif %}>Yes</option>
                                <option value="No" {% if r.enable.is_no %}selected{% endif %}>No</option>
                              </select>
                            </td>

                            <td class="criterion-cell">{{ r.label }}</td>

                            <td>
                              <select id="{{ r.sign.id }}" name="{{ r.sign.name }}" class="form-select form-select-sm">
                                <option value="+/-" {% if r.sign.is_pm %}selected{% endif %}>+/-</option>
                                <option value="+" {% if r.sign.is_plus %}selected{% endif %}>+</option>
                                <option value="-" {% if r.sign.is_minus %}selected{% endif %}>-</option>
                              </select>
                            </td>

                            <td class="threshold-cell">
                              <div class="input-group input-group-sm">
                                <input id="{{ r.threshold.id }}" name="{{ r.threshold.name }}" type="number" step="0.01"
                                  class="form-control form-control-sm"
                                  value="{{ r.threshold.value|default_if_none:'' }}">
                                <span class="input-group-text">%</span>
                              </div>
                            </td>
                          </tr>
                          {% endfor %}
                        </tbody>

                      </table>
                    </div>

                  </div>

                  <!-- ========= Working Capital ========= -->
                  <div class="tab-pane fade" id="inner-wc" role="tabpanel" aria-labelledby="inner-wc-tab">

                    <div class="table-responsive">
                      <table class="table table-sm align-middle caam-table caam-table--rule">
                        <thead>
                          <tr>
                            <th>Enable</th>
                            <th>Criterion</th>
                            <th>Dir</th>
                            <th>Threshold</th>
                          </tr>
                        </thead>

                        <tbody>
                          {% for r in working_capital_settings.rows %}
                          <tr>
                            <td>
                              <select id="{{ r.enable.id }}" name="{{ r.enable.name }}"
                                class="form-select form-select-sm caam-select-yn">
                                <option value="Yes" {% if r.enable.is_yes %}selected{% endif %}>Yes</option>
                                <option value="No" {% if r.enable.is_no %}selected{% endif %}>No</option>
                              </select>
                            </td>

                            <td class="criterion-cell">{{ r.label }}</td>

                            <td>
                              <select id="{{ r.sign.id }}" name="{{ r.sign.name }}" class="form-select form-select-sm">
                                <option value="+/-" {% if r.sign.is_pm %}selected{% endif %}>+/-</option>
                                <option value="+" {% if r.sign.is_plus %}selected{% endif %}>+</option>
                                <option value="-" {% if r.sign.is_minus %}selected{% endif %}>-</option>
                              </select>
                            </td>

                            <td>
                              <input id="{{ r.var.id }}" name="{{ r.var.name }}" type="number" step="0.01"
                                class="form-control form-control-sm" value="{{ r.var.value|default_if_none:'' }}">
                            </td>
                          </tr>
                          {% endfor %}
                        </tbody>

                      </table>
                    </div>

                  </div>

                </div>

              </div>

              <!-- ===================== IHT ===================== -->
              <div class="tab-pane fade" id="outer-iht" role="tabpanel" aria-labelledby="outer-iht-tab">

                <div class="row g-2">
                  <div class="col-12 col-md-4">
                    <label class="form-label small text-muted">Enable</label>
                    <select name="{{ iht_settings.enabled_name }}" id="iht_enable"
                      class="form-select form-select-sm caam-select-yn">
                      <option value="Yes" {% if iht_settings.enabled_is_yes %}selected{% endif %}>Yes</option>
                      <option value="No" {% if iht_settings.enabled_is_no %}selected{% endif %}>No</option>
                    </select>
                  </div>

                  <div class="col-12 col-md-8">
                    <label class="form-label small text-muted">Threshold</label>
                    <div class="input-group input-group-sm">
                      <span class="input-group-text">£</span>
                      <input type="number" name="{{ iht_settings.threshold_name }}" id="iht_valuation_threshold"
                        class="form-control form-control-sm" step="10000" min="0"
                        value="{{ iht_settings.threshold|default_if_none:'' }}">
                    </div>
                  </div>
                </div>

                <div class="form-text mt-2">
                  IHT calculation fields (EBITDA, Multiple, Result) are hidden in this view.
                </div>

              </div>

              <!-- ===================== READINESS (Enable only) ===================== -->
              <div class="tab-pane fade" id="outer-readiness" role="tabpanel" aria-labelledby="outer-readiness-tab">
                <div class="row g-2 mb-2">
                  <div class="col-12 col-md-4">
                    <label class="form-label small text-muted">Readiness target %</label>
                    <input type="number" min="0" max="100" step="1" name="readiness_target_percent"
                      id="target_readiness" class="form-control form-control-sm"
                      value="{{ readiness_settings.target_percent|default_if_none:'' }}">

                  </div>
                </div>



                <div class="table-responsive">
                  <table class="table table-sm align-middle caam-table caam-table--yn">
                    <thead>
                      <tr>
                        <th>Enable</th>
                        <th>Field</th>
                      </tr>
                    </thead>

                    <tbody>
                      {% for row in readiness_settings.rows %}
                      <tr>
                        <td>
                          <select name="{{ row.enabled_name }}" id="id_{{ row.enabled_name }}"
                            class="form-select form-select-sm caam-select-yn">
                            <option value="Yes" {% if row.enabled_is_yes %}selected{% endif %}>Yes</option>
                            <option value="No" {% if row.enabled_is_no %}selected{% endif %}>No</option>
                          </select>
                        </td>

                        <td>{{ row.label }}</td>
                      </tr>
                      {% empty %}
                      <tr>
                        <td colspan="2" class="text-muted text-center py-2">
                          No readiness rows found.
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>

                  </table>
                </div>

              </div>

            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Close</button>
            <button type="button" id="btnSaveCriteria" class="btn btn-login btn-sm px-3">
              Save
            </button>
            <button type="button" id="btnResetToDefaults" class="btn btn-outline-warning btn-sm">
              Reset to defaults
            </button>
            <button type="button" class="btn btn-outline-info btn-sm" id="btnViewDefaults">
              View defaults
            </button>
          </div>

        </form>

      </div>
    </div>
  </div>

  <script>
    window.CAAM_ENDPOINTS = window.CAAM_ENDPOINTS || {};
    window.CAAM_ENDPOINTS.save_config =
      "{% url 'caam:ajax_save_config' client_id=0 %}";

    window.CAAM_PAGE = window.CAAM_PAGE || {};
    window.CAAM_PAGE.companyId = Number("{{ company_id }}");
    window.CAAM_PAGE.version = 0;
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{% static 'vfd_pro/js/caam_report.js' %}" defer></script>

  <!-- Confirm Modal -->
  <div class="modal fade" id="confirmApplyAllModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Apply changes to all clients?</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <p class="mb-2">
            You’re about to update the CAAM configuration at <strong>company level</strong>.
          </p>
          <p class="mb-2">
            These changes will be applied to <strong>all clients</strong> under this company
            (existing settings will be updated; missing settings will be created).
          </p>
          <p class="mb-0 text-warning">
            This action may take a moment depending on the number of clients.
          </p>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="btnConfirmApplyAll" class="btn btn-login btn-sm px-3">
            Yes, apply to all clients
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Processing Modal -->
  <div class="modal fade" id="processingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static"
    data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Processing…</h5>
        </div>

        <div class="modal-body d-flex align-items-center gap-3">
          <div class="spinner-border" role="status" aria-hidden="true"></div>

          <div>
            <div class="fw-semibold">Saving configuration</div>
            <div class="text-white-50">
              Applying changes across all clients. Please wait — this may take a moment.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Reset Modal -->
  <div class="modal fade" id="confirmResetModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Reset company settings to default?</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <p class="mb-2">
            This will delete all existing client-level configs for this company and re-apply the system defaults.
          </p>
          <p class="mb-0 text-warning">
            It will also recalculate reports for all clients (may take some time).
          </p>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="btnConfirmReset" class="btn btn-outline-warning btn-sm">
            Yes, reset to defaults
          </button>
        </div>
      </div>
    </div>
  </div>

  {{ defaults_modal|json_script:"caam-defaults-modal" }}

  <script>
    window.CAAM_DEFAULTS_MODAL = JSON.parse(
      document.getElementById("caam-defaults-modal").textContent
    );
  </script>

  <script>
    (function () {
      const btnSave = document.getElementById("btnSaveCriteria");
      if (!btnSave) return;

      const confirmEl = document.getElementById("confirmApplyAllModal");
      const processingEl = document.getElementById("processingModal");

      const confirmModal = confirmEl ? new bootstrap.Modal(confirmEl) : null;
      const processingModal = processingEl ? new bootstrap.Modal(processingEl) : null;

      const btnConfirm = document.getElementById("btnConfirmApplyAll");

      function isCompanyLevelSave() {
        const url = window.CAAM_ENDPOINTS && window.CAAM_ENDPOINTS.save_config;
        return url && /\/0\/?$/.test(url);
      }

      btnSave.addEventListener("click", async (e) => {
        e.preventDefault();

        if (isCompanyLevelSave() && confirmModal) {
          confirmModal.show();
        } else {
          await runSave();
        }
      });

      if (btnConfirm) {
        btnConfirm.addEventListener("click", async () => {
          confirmModal && confirmModal.hide();
          await runSave();
        });
      }

      async function runSave() {
        processingModal && processingModal.show();

        try {
          await saveConfig();
        } finally {
          processingModal && processingModal.hide();
        }
      }
    })();
  </script>

  <script>
    (function () {
      const modalEl = document.getElementById("companyConfigurationModal");
      if (!modalEl) return;

      const btnView = document.getElementById("btnViewDefaults");
      const btnSave = document.getElementById("btnSaveCriteria");
      const btnReset = document.getElementById("btnResetToDefaults");
      if (!btnView || !btnSave || !btnReset) return;

      const titleEl = modalEl.querySelector(".modal-title");
      const oldTitle = titleEl ? titleEl.textContent : "Setting";

      const footer = modalEl.querySelector(".modal-footer");
      const btnBack = document.createElement("button");
      btnBack.type = "button";
      btnBack.className = "btn btn-outline-primary btn-sm d-none btn-back";
      btnBack.id = "btnBackFromDefaults";
      btnBack.textContent = "Back";
      footer.appendChild(btnBack);

      const snapshot = new Map();

      function setAllDisabled(disabled) {
        const body = modalEl.querySelector(".modal-body");
        if (!body) return;
        body.querySelectorAll("input, select, textarea").forEach(el => {
          el.disabled = !!disabled;
        });
      }

      function findDefaultValueByName(defaultsModal, fieldName) {
        if (!defaultsModal || !fieldName) return undefined;

        // ✅ targets (these were missing)
        if (fieldName === "suitability_target_percent") {
          return defaultsModal?.suitability_settings?.target_percent;
        }
        if (fieldName === "opp_target_percent") {
          return defaultsModal?.perf_settings?.target_percent;
        }
        if (fieldName === "readiness_target_percent") {
          return defaultsModal?.readiness_settings?.target_percent;
        }

        const sRows = (defaultsModal.suitability_settings && defaultsModal.suitability_settings.rows) || [];
        for (const r of sRows) {
          if (r.enabled_name === fieldName) return r.enabled;
        }

        const rRows = (defaultsModal.readiness_settings && defaultsModal.readiness_settings.rows) || [];
        for (const r of rRows) {
          if (r.enabled_name === fieldName) return r.enabled;
        }

        const iht = defaultsModal.iht_settings || {};
        if (iht.enabled_name === fieldName) return iht.enabled;
        if (iht.threshold_name === fieldName) return iht.threshold;
        if (iht.multiple_name === fieldName) return iht.multiple;

        const perf = defaultsModal.perf_settings || {};
        if (perf.period && perf.period.name === fieldName) return perf.period.value;
        if (perf.multiple && perf.multiple.name === fieldName) return perf.multiple.value;

        const groups = []
          .concat(perf.group1 || [])
          .concat(perf.group2 || [])
          .concat(perf.group3 || []);

        for (const g of groups) {
          if (g.enable && g.enable.name === fieldName) return g.enable.value;
          if (g.sign && g.sign.name === fieldName) return g.sign.value;
          if (g.threshold && g.threshold.name === fieldName) return g.threshold.value;
        }

        const wcRows = (defaultsModal.working_capital_settings && defaultsModal.working_capital_settings.rows) || [];
        for (const r of wcRows) {
          if (r.enable && r.enable.name === fieldName) return r.enable.value;
          if (r.sign && r.sign.name === fieldName) return r.sign.value;
          if (r.var && r.var.name === fieldName) return r.var.value;
        }

        return undefined;
      }

      function applyDefaults(defaultsModal) {
        const body = modalEl.querySelector(".modal-body");
        const controls = body.querySelectorAll("input[name], select[name], textarea[name]");

        controls.forEach(el => {
          const name = el.getAttribute("name");
          if (!name) return;

          const defVal = findDefaultValueByName(defaultsModal, name);
          if (typeof defVal === "undefined") return;

          el.value = (defVal === null || typeof defVal === "undefined") ? "" : String(defVal);
        });
      }

      function snapshotCompanyValues() {
        const body = modalEl.querySelector(".modal-body");
        body.querySelectorAll("input[name], select[name], textarea[name]").forEach(el => {
          snapshot.set(el.name, el.value);
        });
      }

      function restoreCompanyValues() {
        const body = modalEl.querySelector(".modal-body");
        body.querySelectorAll("input[name], select[name], textarea[name]").forEach(el => {
          if (snapshot.has(el.name)) el.value = snapshot.get(el.name);
        });
      }

      function enterDefaultsMode() {
        const defaultsModal = window.CAAM_DEFAULTS_MODAL;
        if (!defaultsModal) {
          alert("Defaults not loaded.");
          return;
        }

        snapshotCompanyValues();
        applyDefaults(defaultsModal);

        setAllDisabled(true);

        btnSave.classList.add("d-none");
        btnReset.classList.add("d-none");
        btnView.classList.add("d-none");
        btnBack.classList.remove("d-none");

        if (titleEl) titleEl.textContent = "Default settings (read-only)";
      }

      function exitDefaultsMode() {
        restoreCompanyValues();
        setAllDisabled(false);

        btnSave.classList.remove("d-none");
        btnReset.classList.remove("d-none");
        btnView.classList.remove("d-none");
        btnBack.classList.add("d-none");

        if (titleEl) titleEl.textContent = oldTitle;
      }

      btnView.addEventListener("click", enterDefaultsMode);
      btnBack.addEventListener("click", exitDefaultsMode);

      modalEl.addEventListener("hidden.bs.modal", () => {
        if (!btnBack.classList.contains("d-none")) exitDefaultsMode();
      });
    })();
  </script>

  <script>
    (function () {
      const btnReset = document.getElementById("btnResetToDefaults");
      const confirmEl = document.getElementById("confirmResetModal");
      const processingEl = document.getElementById("processingModal");
      const btnConfirmReset = document.getElementById("btnConfirmReset");

      if (!btnReset || !confirmEl || !processingEl || !btnConfirmReset || !window.bootstrap) return;

      const confirmModal = new bootstrap.Modal(confirmEl);
      const processingModal = new bootstrap.Modal(processingEl);

      btnReset.addEventListener("click", () => confirmModal.show());

      btnConfirmReset.addEventListener("click", async () => {
        confirmModal.hide();
        processingModal.show();
        try {
          await window.saveConfig({ resetFlag: 1 });
          // ✅ cache-busting reload
          const url = new URL(window.location.href);
          url.searchParams.set("_", Date.now().toString());
          window.location.replace(url.toString());

        } finally {
          processingModal.hide();
        }
      });
    })();
  </script>

  <script>
    window.addEventListener("pageshow", function (e) {
      if (e.persisted) {
        window.location.reload();
      }
    });
  </script>



</body>

</html>